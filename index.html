<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LIFF + Construct3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="generator" content="Scirra Construct">

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
  <link rel="icon" type="image/png" href="icons/icon-512.png">
  <link rel="stylesheet" href="style.css">

  <!-- ✅ 載入 LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body style="margin:0; padding:0; overflow:hidden; background:#000;">
  <script>
    const LIFF_ID = "2008129352-Ml3XP4xL"; // 換成你的 LIFF ID

    async function initLiff() {
      console.log("🟢 [HTML] 開始初始化 LIFF...");
      try {
        await liff.init({ liffId: LIFF_ID });
        console.log("✅ [HTML] LIFF 初始化成功");

        if (!liff.isLoggedIn()) {
          console.log("⚠️ [HTML] 未登入，進行登入中...");
          liff.login({ redirectUri: location.href });
          return;
        }

        const profile = await liff.getProfile();
        console.log("✅ [HTML] 成功取得 LINE Profile：", profile);

        // 建立全域物件供 C3 使用
        window.LIFF_USER = {
          name: profile.displayName,
          userId: profile.userId,
          pictureUrl: profile.pictureUrl,
          statusMessage: profile.statusMessage || ""
        };
        console.log("🧩 [HTML] 已建立 window.LIFF_USER：", window.LIFF_USER);

        // 檢查 runtime 狀態
        await waitForConstructRuntime();

        // 更新 Construct 3
        const rt = globalThis.C3_GetRuntime?.() || globalThis.C3?.runtime;
        if (rt) {
          rt.globalVars.NAME = window.LIFF_USER.name;
          const txt = rt.objects.Text?.getFirstInstance?.();
          if (txt) txt.text = `你好，${window.LIFF_USER.name}！`;
          console.log("✨ [HTML] 已更新 C3 內的文字物件");
        } else {
          console.warn("❌ [HTML] 找不到 Construct 3 runtime");
        }

      } catch (err) {
        console.error("💥 [HTML] LIFF 初始化失敗：", err);
        alert("無法初始化 LIFF，請從 LINE App 內重新開啟。");
      }
    }

    // 等待 Construct 3 runtime 建立
    async function waitForConstructRuntime() {
      let rt;
      let retries = 0;
      while (!rt && retries < 100) {
        rt = globalThis.C3_GetRuntime?.() || globalThis.C3?.runtime;
        if (rt) {
          console.log("✅ [HTML] Construct 3 runtime 已建立");
          return rt;
        }
        retries++;
        console.log("⏳ [HTML] 等待 Construct 3 runtime... 第", retries, "次");
        await new Promise(r => setTimeout(r, 100));
      }
      throw new Error("Construct 3 runtime 無法建立");
    }

    // 初始化流程
    window.addEventListener("load", () => {
      initLiff();
      console.log("🚀 [HTML] Construct 3 啟動中...");
    });
  </script>

  <!-- ✅ Construct 3 核心腳本 -->
  <script src="scripts/modernjscheck.js"></script>
  <script src="scripts/supportcheck.js"></script>
  <script src="scripts/offlineclient.js" type="module"></script>
  <script src="scripts/main.js" type="module"></script>
  <script src="scripts/register-sw.js" type="module"></script>

</body>
</html>
