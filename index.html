<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LIFF + Construct3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="generator" content="Scirra Construct">

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
  <link rel="icon" type="image/png" href="icons/icon-512.png">
  <link rel="stylesheet" href="style.css">

  <!-- âœ… è¼‰å…¥ LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body style="margin:0; padding:0; overflow:hidden; background:#000;">
  <script>
    const LIFF_ID = "2008129352-Ml3XP4xL"; // æ›æˆä½ çš„ LIFF ID

    async function initLiff() {
      console.log("ğŸŸ¢ [HTML] é–‹å§‹åˆå§‹åŒ– LIFF...");
      try {
        await liff.init({ liffId: LIFF_ID });
        console.log("âœ… [HTML] LIFF åˆå§‹åŒ–æˆåŠŸ");

        if (!liff.isLoggedIn()) {
          console.log("âš ï¸ [HTML] æœªç™»å…¥ï¼Œé€²è¡Œç™»å…¥ä¸­...");
          liff.login({ redirectUri: location.href });
          return;
        }

        const profile = await liff.getProfile();
        console.log("âœ… [HTML] æˆåŠŸå–å¾— LINE Profileï¼š", profile);

        // å»ºç«‹å…¨åŸŸç‰©ä»¶ä¾› C3 ä½¿ç”¨
        window.LIFF_USER = {
          name: profile.displayName,
          userId: profile.userId,
          pictureUrl: profile.pictureUrl,
          statusMessage: profile.statusMessage || ""
        };
        console.log("ğŸ§© [HTML] å·²å»ºç«‹ window.LIFF_USERï¼š", window.LIFF_USER);

        // æª¢æŸ¥ runtime ç‹€æ…‹
        await waitForConstructRuntime();

        // æ›´æ–° Construct 3
        const rt = globalThis.C3_GetRuntime?.() || globalThis.C3?.runtime;
        if (rt) {
          rt.globalVars.NAME = window.LIFF_USER.name;
          const txt = rt.objects.Text?.getFirstInstance?.();
          if (txt) txt.text = `ä½ å¥½ï¼Œ${window.LIFF_USER.name}ï¼`;
          console.log("âœ¨ [HTML] å·²æ›´æ–° C3 å…§çš„æ–‡å­—ç‰©ä»¶");
        } else {
          console.warn("âŒ [HTML] æ‰¾ä¸åˆ° Construct 3 runtime");
        }

      } catch (err) {
        console.error("ğŸ’¥ [HTML] LIFF åˆå§‹åŒ–å¤±æ•—ï¼š", err);
        alert("ç„¡æ³•åˆå§‹åŒ– LIFFï¼Œè«‹å¾ LINE App å…§é‡æ–°é–‹å•Ÿã€‚");
      }
    }

    // ç­‰å¾… Construct 3 runtime å»ºç«‹
    async function waitForConstructRuntime() {
      let rt;
      let retries = 0;
      while (!rt && retries < 100) {
        rt = globalThis.C3_GetRuntime?.() || globalThis.C3?.runtime;
        if (rt) {
          console.log("âœ… [HTML] Construct 3 runtime å·²å»ºç«‹");
          return rt;
        }
        retries++;
        console.log("â³ [HTML] ç­‰å¾… Construct 3 runtime... ç¬¬", retries, "æ¬¡");
        await new Promise(r => setTimeout(r, 100));
      }
      throw new Error("Construct 3 runtime ç„¡æ³•å»ºç«‹");
    }

    // åˆå§‹åŒ–æµç¨‹
    window.addEventListener("load", () => {
      initLiff();
      console.log("ğŸš€ [HTML] Construct 3 å•Ÿå‹•ä¸­...");
    });
  </script>

  <!-- âœ… Construct 3 æ ¸å¿ƒè…³æœ¬ -->
  <script src="scripts/modernjscheck.js"></script>
  <script src="scripts/supportcheck.js"></script>
  <script src="scripts/offlineclient.js" type="module"></script>
  <script src="scripts/main.js" type="module"></script>
  <script src="scripts/register-sw.js" type="module"></script>

</body>
</html>
