<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LIFF + Construct3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="generator" content="Scirra Construct">

  <link rel="manifest" href="appmanifest.json">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/icon-256.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
  <link rel="icon" type="image/png" href="icons/icon-512.png">
  <link rel="stylesheet" href="style.css">

  <!-- âœ… è¼‰å…¥ LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body style="margin:0; padding:0; overflow:hidden; background:#000;">
  <script>
    const LIFF_ID = "2008129352-Ml3XP4xL"; // æ›æˆä½ çš„ LIFF ID

    async function initLiff() {
      console.log("ğŸŸ¢ [HTML] é–‹å§‹åˆå§‹åŒ– LIFF...");
      try {
        await liff.init({ liffId: LIFF_ID });
        console.log("âœ… [HTML] LIFF åˆå§‹åŒ–æˆåŠŸ");

        if (!liff.isLoggedIn()) {
          console.log("âš ï¸ [HTML] æœªç™»å…¥ï¼Œå°å‘ç™»å…¥...");
          liff.login({ redirectUri: location.href });
          return;
        }

        const profile = await liff.getProfile();
        console.log("âœ… [HTML] æˆåŠŸå–å¾— LINE Profileï¼š", profile);

        // å»ºç«‹å…¨åŸŸè®Šæ•¸ä¾› C3 å–ç”¨
        window.LIFF_USER = {
          name: profile.displayName,
          userId: profile.userId,
          pictureUrl: profile.pictureUrl,
          statusMessage: profile.statusMessage || ""
        };
        console.log("ğŸ§© [HTML] å·²å»ºç«‹ window.LIFF_USERï¼š", window.LIFF_USER);

        // ğŸ”¹ é€™è£¡ä¸ç­‰å¾… runtimeï¼Œæ”¹æˆç›£è½ Construct è¼‰å…¥å®Œæˆå¾Œå†æ›´æ–°
        window.addEventListener("C3Ready", updateConstruct);

      } catch (err) {
        console.error("ğŸ’¥ [HTML] LIFF åˆå§‹åŒ–å¤±æ•—ï¼š", err);
        alert("LIFF åˆå§‹åŒ–æˆåŠŸï¼Œä½† Construct å°šæœªè¼‰å…¥æˆ–æœ‰éŒ¯èª¤ã€‚");
      }
    }

    // Construct å•Ÿå‹•å¾Œå‘¼å«
    async function updateConstruct() {
      console.log("ğŸš€ [HTML] æ”¶åˆ° C3Ready äº‹ä»¶ï¼Œæº–å‚™æ›´æ–°æ–‡å­—");
      const rt = globalThis.C3_GetRuntime?.() || globalThis.C3?.runtime;

      if (!rt) {
        console.warn("âŒ [HTML] Construct runtime ä»ä¸å­˜åœ¨");
        return;
      }

      if (!window.LIFF_USER) {
        console.warn("âš ï¸ [HTML] å°šæœªå–å¾— LIFF_USERï¼Œç•¥éæ›´æ–°");
        return;
      }

      rt.globalVars.NAME = window.LIFF_USER.name;
      const txt = rt.objects.Text?.getFirstInstance?.();
      if (txt) txt.text = `ä½ å¥½ï¼Œ${window.LIFF_USER.name}ï¼`;
      console.log("âœ¨ [HTML] æˆåŠŸæ›´æ–° Construct æ–‡å­—ç‰©ä»¶");
    }

    // Construct åˆå§‹åŒ–å®Œæˆæ™‚æœƒè‡ªå‹•å‘¼å«æ­¤äº‹ä»¶
    window.addEventListener("load", () => {
      console.log("ğŸš€ [HTML] é é¢è¼‰å…¥ï¼Œå•Ÿå‹• LIFF åˆå§‹åŒ–");
      initLiff();
    });

    // Construct çš„ runtime è¼‰å…¥å®Œå¾Œæ‰‹å‹•æ´¾ç™¼äº‹ä»¶
    (function waitForC3() {
      let retries = 0;
      const timer = setInterval(() => {
        const rt = globalThis.C3_GetRuntime?.() || globalThis.C3?.runtime;
        if (rt) {
          clearInterval(timer);
          console.log("âœ… [HTML] Construct runtime æº–å‚™å®Œæˆ");
          window.dispatchEvent(new Event("C3Ready"));
        } else if (++retries > 100) {
          clearInterval(timer);
          console.error("âŒ [HTML] Construct runtime åˆå§‹åŒ–è¶…æ™‚");
        }
      }, 100);
    })();
  </script>

  <!-- âœ… Construct 3 æ ¸å¿ƒ -->
  <script src="scripts/modernjscheck.js"></script>
  <script src="scripts/supportcheck.js"></script>
  <script src="scripts/offlineclient.js" type="module"></script>
  <script src="scripts/main.js" type="module"></script>
  <script src="scripts/register-sw.js" type="module"></script>
</body>
</html>
